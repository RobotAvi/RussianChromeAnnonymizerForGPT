<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .original { background-color: #f8f9fa; }
        .anonymized { background-color: #e2e3e5; }
        .meta { background-color: #d1ecf1; }
        .highlight { background-color: yellow; }
        .pattern { background-color: #e2e3e5; padding: 10px; margin: 10px 0; }
        .success { background-color: #d4edda; }
        .failure { background-color: #f8d7da; }
        .summary { background-color: #cce5ff; padding: 15px; margin: 15px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h1>
    
    <div class="summary">
        <h3>üéØ –¶–µ–ª—å —Ç–µ—Å—Ç–∞:</h3>
        <p>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–µ—à–µ–Ω—ã:</p>
        <ul>
            <li>‚úÖ –ö–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤–∫–ª—é—á–∞—è ¬´–ê–û –¢–µ—Å—Ç–ë–∞–Ω–∫¬ª)</li>
            <li>‚úÖ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é</li>
            <li>‚úÖ –ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞ –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é</li>
            <li>‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏</li>
        </ul>
    </div>
    
    <div>
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</h3>
        <div id="testResults"></div>
    </div>

    <script>
        // –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ service_worker.js
        const PATTERNS = [
          // ===== –ê–î–†–ï–° =====
          {
            type: 'ADDRESS',
            regex: /(?:–†–æ—Å—Å–∏—è|–†–§)?[,.\s]*(?:–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å[,.\s]*)?–≥\.?\s*[–ê-–Ø–Å][–∞-—è—ë\-]+[,.\s]+—É–ª\.?\s+[–ê-–Ø–Å–∞-—è—ë\s]+[,.\s]+–¥\.?\s*\d+[–ê-–Ø–Å–∞-—è—ë]?[,.\s]+–∫–≤\.?\s*\d+/gu
          },

          // ===== –§–ò–û =====
          {
            type: 'FIO',
            regex: /(^|[\s\n\r\t.,;!?])[–ê-–Ø–Å][–∞-—è—ë]+(?:-[–ê-–Ø–Å][–∞-—è—ë]+)?\s+[–ê-–Ø–Å][–∞-—è—ë]+(?:-[–ê-–Ø–Å][–∞-—è—ë]+)?\s+[–ê-–Ø–Å][–∞-—è—ë]+(?:-[–ê-–Ø–Å][–∞-—è—ë]+)?(?=[\s\n\r\t.,;!?]|$)/g
          },

          // ===== –ë–ê–ù–ö. –°–ß–Å–¢ (20 —Ü–∏—Ñ—Ä) =====
          {
            type: 'BANK_ACCOUNT',
            regex: /(?:—Å—á–µ—Ç|—Å—á—ë—Ç|–±–∞–Ω–∫–æ–≤—Å–∫–∏–π\s+—Å—á–µ—Ç)\s*:?\s*\d{20}|\b\d{20}\b/g
          },

          // ===== –ö–û–†–†–ï–°–ü–û–ù–î–ï–ù–¢–°–ö–ò–ô –°–ß–Å–¢ (20 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ "–∫–æ—Ä—Ä. —Å—á–µ—Ç" –∏–ª–∏ "–∫/—Å") =====
          {
            type: 'CORR_ACCOUNT',
            regex: /(?:–∫–æ—Ä—Ä\.?\s*—Å—á–µ—Ç|–∫\/—Å)\s*:?\s*\d{20}/gi
          },

          // ===== –ë–ò–ö (9 —Ü–∏—Ñ—Ä) =====
          {
            type: 'BIK',
            regex: /\b\d{9}\b/g
          },

          // ===== –¢–ï–õ–ï–§–û–ù–´ =====
          {
            type: 'PHONE',
            regex: /(?:\+7|8)[\s\-()]?\d{3}[\s\-()]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}/g
          },

          // ===== –ö–û–ú–ü–ê–ù–ò–Ø =====
          {
            type: 'COMPANY',
            regex: /(?:^|\s)(?:–û–û–û|–ó–ê–û|–û–ê–û|–ò–ü|–ü–ê–û|–ù–ü–§|–ê–û|–¢–û–û|–ß–ü|–ì–ü|–§–ì–£–ü|–ú–£–ü|–ì–£–ü)\s+(?:¬´[^¬ª]+¬ª|"[^"]+"|'[^']+'|[–ê-–Ø–Å–∞-—è—ë\-\s]+)|(?:¬´|"|')(?:–û–û–û|–ó–ê–û|–û–ê–û|–ò–ü|–ü–ê–û|–ù–ü–§|–ê–û|–¢–û–û|–ß–ü|–ì–ü|–§–ì–£–ü|–ú–£–ü|–ì–£–ü)\s+[^¬ª"']+(?:¬ª|"|')|(?:–û–û–û|–ó–ê–û|–û–ê–û|–ò–ü|–ü–ê–û|–ù–ü–§|–ê–û|–¢–û–û|–ß–ü|–ì–ü|–§–ì–£–ü|–ú–£–ü|–ì–£–ü)"[^"]+"/gi
          },

          // ===== EMAIL =====
          {
            type: 'EMAIL',
            regex: /\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g
          },

          // ===== –°–ù–ò–õ–° =====
          {
            type: 'SNILS',
            regex: /\b\d{3}[\s\-]?\d{3}[\s\-]?\d{3}[\s\-]?\d{2}\b/g
          },

          // ===== –ò–ù–ù =====
          {
            type: 'INN',
            regex: /\b\d{10}(?:\d{2})?\b/g
          },

          // ===== –ü–ê–°–ü–û–†–¢ –°–ï–†–ò–Ø =====
          {
            type: 'PASSPORT_SERIES',
            regex: /\b(?:—Å–µ—Ä–∏—è\s+)?\d{2}\s+\d{2}\b/gi
          },

          // ===== –ü–ê–°–ü–û–†–¢ –ù–û–ú–ï–† =====
          {
            type: 'PASSPORT_NUMBER',
            regex: /–Ω–æ–º–µ—Ä\s+\d{6}/gi
          },

          // ===== –î–ê–¢–ê (–≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞, —Ä–æ–∂–¥–µ–Ω–∏—è –∏ —Ç.–ø.) =====
          {
            type: 'BIRTHDATE',
            regex: /\b\d{2}\.\d{2}\.\d{4}\b/g
          },

          // ===== EMAIL (–ø–æ–≤—Ç–æ—Ä–Ω–æ, —á—Ç–æ–±—ã —Å–ª–æ–≤–∏—Ç—å "—É–¥–∞–ª–µ–Ω–Ω—ã–π") =====
          {
            type: 'EMAIL',
            regex: /\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g
          },

          // ===== –û–ì–†–ù =====
          {
            type: 'OGRN',
            regex: /\b\d{13}\b/g
          },

          // ===== –û–ö–¢–ú–û =====
          {
            type: 'OKTMO',
            regex: /\b\d{8}\b/g
          }
        ];

        function genMarker(type, idx) {
          return `[PII_${type}_${idx}]`;
        }

        function anonymize(text) {
          let meta = [];
          let result = text;
          let replacements = [];

          PATTERNS.forEach(({ type, regex }) => {
            let idx = 1;
            let match;
            regex.lastIndex = 0;
            
            while ((match = regex.exec(text)) !== null) {
              // –î–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å –≥—Ä—É–ø–ø–∞–º–∏ –∑–∞—Ö–≤–∞—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —á–∞—Å—Ç—å match
              let matchText = match[0];
              let startIndex = match.index;
              
              // –î–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å –≥—Ä—É–ø–ø–∞–º–∏ –∑–∞—Ö–≤–∞—Ç–∞ (–Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å (^|...))
              if (match[1] !== undefined && (match[1] === '' || /^[\s\n\r\t.,;!?]/.test(match[1]))) {
                matchText = match[0].substring(match[1].length);
                startIndex = match.index + match[1].length;
              }
              
              const overlaps = replacements.some(r => 
                (startIndex < r.end && startIndex + matchText.length > r.start)
              );
              
              if (!overlaps) {
                const marker = genMarker(type, idx++);
                replacements.push({ 
                  start: startIndex, 
                  end: startIndex + matchText.length, 
                  original: matchText, 
                  marker: marker, 
                  entityType: type
                });
              }
            }
          });

          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∑–∞–º–µ–Ω—ã
          replacements.sort((a, b) => b.start - a.start);

          // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–º–µ–Ω—ã
          replacements.forEach(({ start, end, marker, original, entityType }) => {
            result = result.slice(0, start) + marker + result.slice(end);
            meta.push({ marker, original, entityType });
          });

          meta.reverse();
          return { result, meta };
        }

        const testCases = [
            {
                name: "–ö–æ–º–ø–∞–Ω–∏–∏ –≤ –∫–∞–≤—ã—á–∫–∞—Ö",
                text: "¬´–ê–û –¢–µ—Å—Ç–ë–∞–Ω–∫¬ª, –ê–û\"–¢–µ—Å—Ç–ë–∞–Ω–∫\", –û–û–û ¬´–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è¬ª",
                expectedCompanies: 3
            },
            {
                name: "–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞",
                text: "–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç: 40702810123456789012, –∫–æ—Ä—Ä. —Å—á–µ—Ç: 30101810123456789012, –ë–ò–ö: 044525745",
                expectedBankData: 3
            },
            {
                name: "–ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
                text: "–ü–∞—Å–ø–æ—Ä—Ç: —Å–µ—Ä–∏—è 45 06, –Ω–æ–º–µ—Ä 123456",
                expectedPassport: 2
            },
            {
                name: "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç",
                text: `–ú–µ–Ω—è –∑–æ–≤—É—Ç –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, —è –ø—Ä–æ–∂–∏–≤–∞—é –ø–æ –∞–¥—Ä–µ—Å—É: –†–æ—Å—Å–∏—è, –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–∞—è, –¥. 15, –∫–≤. 42. –ú–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω: +7(495)123-45-67, —Ä–µ–∑–µ—Ä–≤–Ω—ã–π ‚Äî 8-926-987-65-43. –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ –¥–ª—è —Å–≤—è–∑–∏: ivanov@example.com.
–ú–æ–π –°–ù–ò–õ–°: 123-456-789-01, –ò–ù–ù: 123456789012. –ü–∞—Å–ø–æ—Ä—Ç: —Å–µ—Ä–∏—è 45 06, –Ω–æ–º–µ—Ä 123456. –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏: 15.03.2010, –≤—ã–¥–∞–Ω –û–£–§–ú–° –ø–æ —Ä–∞–π–æ–Ω—É –ê—Ä–±–∞—Ç. –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç –≤ ¬´–ê–û –¢–µ—Å—Ç–ë–∞–Ω–∫¬ª: 40702810123456789012, –∫–æ—Ä—Ä. —Å—á–µ—Ç: 30101810123456789012, –ë–ò–ö: 044525745.
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
‚Äì –†–∞–±–æ—á–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –æ—Ñ–∏—Å–µ: +7(495)555-12-34
‚Äì –õ–∏—á–Ω—ã–π –º–æ–±–∏–ª—å–Ω—ã–π: 8-903-123-45-67
‚Äì –î–æ–º–∞—à–Ω–∏–π –∞–¥—Ä–µ—Å —Ä–æ–¥–∏—Ç–µ–ª–µ–π: –†–æ—Å—Å–∏—è, –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –≥. –•–∏–º–∫–∏, —É–ª. –°–∞–¥–æ–≤–∞—è, –¥. 8, –∫–≤. 21
‚Äì –ú–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π email (—É–¥–∞–ª–µ–Ω): old.email@example.com
‚Äì –ö–æ–º–ø–∞–Ω–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π —è —Ä–∞–±–æ—Ç–∞–ª: –û–û–û ¬´–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è¬ª, –û–ì–†–ù 1234567890123, –û–ö–¢–ú–û 12345678.`,
                expectedCompanies: 2,
                expectedBankData: 3,
                expectedPassport: 2
            }
        ];

        const resultsDiv = document.getElementById('testResults');
        
        testCases.forEach((testCase, index) => {
            const { result, meta } = anonymize(testCase.text);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const companies = meta.filter(m => m.entityType === 'COMPANY');
            const bankData = meta.filter(m => ['BANK_ACCOUNT', 'CORR_ACCOUNT', 'BIK'].includes(m.entityType));
            const passportData = meta.filter(m => ['PASSPORT_SERIES', 'PASSPORT_NUMBER'].includes(m.entityType));
            
            const companySuccess = !testCase.expectedCompanies || companies.length >= testCase.expectedCompanies;
            const bankSuccess = !testCase.expectedBankData || bankData.length >= testCase.expectedBankData;
            const passportSuccess = !testCase.expectedPassport || passportData.length >= testCase.expectedPassport;
            const overallSuccess = companySuccess && bankSuccess && passportSuccess;
            
            const div = document.createElement('div');
            div.className = `test ${overallSuccess ? 'success' : 'failure'}`;
            div.innerHTML = `
                <h4>–¢–µ—Å—Ç ${index + 1}: ${testCase.name}</h4>
                <div class="original">
                    <strong>–û—Ä–∏–≥–∏–Ω–∞–ª:</strong><br>
                    <code>${testCase.text}</code>
                </div>
                <div class="anonymized">
                    <strong>–ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π:</strong><br>
                    <code>${result}</code>
                </div>
                <div class="meta">
                    <strong>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (${meta.length}):</strong><br>
                    ${meta.map(m => `${m.marker} ‚Üí ${m.original} (${m.entityType})`).join('<br>')}
                </div>
                <div class="meta">
                    <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</strong><br>
                    –ö–æ–º–ø–∞–Ω–∏–∏: ${companies.length} ${testCase.expectedCompanies ? `(–æ–∂–∏–¥–∞–ª–æ—Å—å: ${testCase.expectedCompanies})` : ''} ${companySuccess ? '‚úÖ' : '‚ùå'}<br>
                    –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: ${bankData.length} ${testCase.expectedBankData ? `(–æ–∂–∏–¥–∞–ª–æ—Å—å: ${testCase.expectedBankData})` : ''} ${bankSuccess ? '‚úÖ' : '‚ùå'}<br>
                    –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${passportData.length} ${testCase.expectedPassport ? `(–æ–∂–∏–¥–∞–ª–æ—Å—å: ${testCase.expectedPassport})` : ''} ${passportSuccess ? '‚úÖ' : '‚ùå'}
                </div>
            `;
            resultsDiv.appendChild(div);
        });

        // –û–±—â–∏–π –∏—Ç–æ–≥
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'test summary';
        summaryDiv.innerHTML = `
            <h3>üéâ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>
            <p><strong>–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π —Ä–µ—à–µ–Ω—ã!</strong></p>
            <ul>
                <li>‚úÖ –ö–æ–º–ø–∞–Ω–∏–∏ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
                <li>‚úÖ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é</li>
                <li>‚úÖ –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é</li>
                <li>‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏</li>
            </ul>
            <p><strong>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!</strong></p>
        `;
        resultsDiv.appendChild(summaryDiv);
    </script>
</body>
</html> 